<!doctype html>
<html>
<head>
  <!-- jquery -->
  <script src="/bower_components/jquery/jquery.js"></script>

  <!-- fontawesome -->
  <link rel="stylesheet" type="text/css" href="/bower_components/fontawesome/css/font-awesome.css">

  <!-- bootstrap 3 -->
  <link rel="stylesheet" type="text/css" href="bower_components/bootstrap/dist/css/bootstrap.css">
  <script type="text/javascript" src="/bower_components/bootstrap/dist/js/bootstrap.js"></script>

  <!-- swagger-js -->
  <script type="text/javascript" src="/bower_components/swagger-js/lib/shred.bundle.js"></script>
  <script type="text/javascript" src="/bower_components/swagger-js/lib/swagger.js"></script>

  <style type="text/css">
  body {
    padding-top: 60px;
  }
  </style>
</head>
<body>
  <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="#">AIP</a>
      </div>
    </div>
  </nav>

  <header class="container">
    <div class="page-header">
      <h1>AIP Science Apps <small>Test Runner</small></h1>
    </div>
  </header>

  <div class="api-credentials container">
    <p>
      In order to use any APIs secured by Agave, you will need to get an API
      token. If you have already created an API client, please enter the key
      and secret below, as well as your API username and password. Then click
      &quot;Get Token&quot;.
    </p>
    <form method="post" name="__api_token_form">
      <div class="form-group">
        <input name="consumerKey" type="text" class="form-control" placeholder="Consumer Key">
      </div>

      <div class="form-group">
        <input name="consumerSecret" type="text" class="form-control" placeholder="Consumer Secret">
      </div>

      <div class="form-group">
        <input name="username" type="text" class="form-control" placeholder="Username">
      </div>

      <div class="form-group">
        <input name="password" type="text" class="form-control" placeholder="Password">
      </div>

      <input type="hidden" name="grant_type" value="password">
      <input type="hidden" name="scope" value="PRODUCTION">

      <div class="form-actions">
        <button type="submit" class="btn btn-success">Get Token</button>
        <a href="#" class="btn btn-link">Don't have an API Client?</a>
      </div>
    </form>
  </div>

  <div class="container">
    include "app/app.html"
  </div>


  <script type="text/javascript">
    (function(window,$,undefined){
      var form = $('form[name=__api_token_form]');

      var agaveClient = window.localStorage.getItem('agaveClient');
      if (agaveClient) {
        try {
          agaveClient = JSON.parse(agaveClient);
          $.each(agaveClient, function(key, value) {
            $('[name='+key+']', form).val(value);
          });
        } catch (err) {
          console.log(err);
        }
      }

      var Agave = window.Agave || {};
      var agaveToken = window.localStorage.getItem('agaveToken');
      if (agaveToken) {
        try {
          var oauth2 = JSON.parse(agaveToken);
          if (Date.now() - oauth2.created < (1000 * oauth2.expires_in)) {
            Agave.oauth2 = oauth2
          }
        } catch (err) {
          console.log(err);
        }
      }

      if (Agave.oauth2) {
        $('<p><br>Current Token: <span class="label label-info">'+ Agave.oauth2.access_token +'</span></p>').appendTo($('.api-credentials'));
      } else {
        $('<p><br>Current Token: <span class="label label-danger">invalid</span></p>').appendTo($('.api-credentials'));
      }

      form.on('submit', function(e) {
        e.preventDefault();
        var form = $(this),
          agaveClient = {},
          data = form.serialize();

        var authorization = btoa(form[0].consumerKey.value + ':' + form[0].consumerSecret.value);

        $.ajax({
          url: 'https://api.araport.org/token',
          type: 'post',
          data: data,
          headers: {
            Authorization: 'Basic ' + authorization
          },
          success: function(resp) {


            window.localStorage.setItem('agaveClient', JSON.stringify({
              consumerKey: form[0].consumerKey.value,
              consumerSecret: form[0].consumerSecret.value
            }));

            resp.created = Date.now();

            window.localStorage.setItem('agaveToken', JSON.stringify(resp));

            var Agave = window.Agave || {};
            Agave.oauth2 = resp;
            window.Agave = Agave;
          }
        });
      });

      window.authorizations.add('Authorization', new ApiKeyAuthorization('Authorization', 'Bearer ' + Agave.oauth2.access_token, 'header'));
      Agave.api = new SwaggerApi({
        url: '//localhost:9000/resources',
        success: function() {
          if (Agave.api.ready === true) {
            console.log('AgaveAPI bootstrapped!');
          }
        }
      });
      window.Agave = Agave;
    })(window, jQuery);
  </script>
</body>
</html>
